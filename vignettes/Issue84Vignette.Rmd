---
title: "Issue 84 Vignette"
author: "Abe Rycus"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Balance Plotting}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
library(tidyverse)
library(optmatch)
library(RItools)
```

This vignette is in regards to issue 84 of the RItools package, which focuses on the plotting of balance tests, a stistical test that tests whether there is appropriate randomization between treatment and control groups. In other words, it checks to see if the covariate distributions between the treatment and control groups are as expected. 

As an example of a balance plot, which are simply plots of balance tests, the 2013-2014 NHANES data, which includes data on Aspirin useage, will be used. The response variable is a binary variable which is 1 if the patient has taken a doseage of Aspirin and 0 otherwise. The data also has a number of explanatory variables. 

```{r}
# Reading in aspirin data
aspirin <- read_xpt("./RXQASA_H.XPT")

eq1 <- function(x) {
  tmp <- x == 1 
  tmp[is.na(tmp)] <- FALSE
  return(tmp)
}

aspirin$taking_aspirin <- eq1(aspirin$RXQ515) | eq1(aspirin$RXQ520)

## Blood pressure exam
# https://wwwn.cdc.gov/Nchs/Nhanes/2013-2014/BPX_H.htm 

bp <- read_xpt("./BPX_H.XPT")

bp$sys_mean <- rowMeans(bp[, c("BPXSY1", "BPXSY2", "BPXSY3", "BPXSY4")], na.rm = TRUE)
bp$dia_mean <- rowMeans(bp[, c("BPXDI1", "BPXDI2", "BPXDI3", "BPXDI4")], na.rm = TRUE)

## now we need to match up the aspirin and bp tables


temp <- aspirin[aspirin$SEQN %in% bp$SEQN, ]

rownames(bp) <- bp$SEQN

combined <- cbind(temp, bp[as.character(temp$SEQN), ])

### TODO: load DEMO_H.XPT and merge it in
### https://wwwn.cdc.gov/nchs/nhanes/search/datapage.aspx?Component=Demographics&CycleBeginYear=2013


save.image(file = "analyzing_aspirin_data.rda")

demo <- read_xpt("./DEMO_H.XPT")

data <- aspirin %>% left_join(demo)
# save analzing_aspirin_Data.rda again 

```
Now the dataframe named simply as data is ready to be used to produced balance plots. 

```{r}
fm <- fullmatch(taking_aspirin ~ RXQ515 + SIAPROXY + WTINT2YR, data = data)

bt <- balanceTest(taking_aspirin ~ RXQ515 + SIAPROXY + WTINT2YR, data = data)
  
plot(bt)
View(data)
plot.balancetest(bt)
```

These plots above are the same but were called using different functions, the normal plot function from base R and plot.balancetest() from RItools. These are included to demonstrate that both functions can be used to produce the same plot. RIDRETH1 is a categorical variable where each level represents the patients race. It has 6 levels. The variable DMDHRAGE gives the age of the HH reference persons, in years. The variable INDFMIN2 is the total family income reported as a range value, in dollars.

```{r}
fm <- fullmatch(taking_aspirin ~ as.factor(RIDRETH1) + DMDHRAGE + INDFMIN2, data = data)

bal <- xBalance(taking_aspirin ~ as.factor(RIDRETH1) + DMDHRAGE + INDFMIN2, data = data, strata = list(~ fm, unstratified = NULL))

x <- as.data.frame(RItools:::prepareXbalForPlot(bal))

x <- rownames_to_column(x)

x <- gather(x, strata, values, -rowname)

plot.xbal(bal, ggplot = FALSE)

plot(bal, ggplot = FALSE)

plot.xbal(bal, ggplot = TRUE)

plot(bal, ggplot = TRUE) + theme_bw()


```

To increase ease and efficiency of plotting, the ggplot argument was added to the plot.xbal() function in plot.xbal.R. Set to false by default, it allows the user to decide whether or not the balance plot is to be produced using ggplot, which usually provides better plots, or base-R plotting. These four plots show how both the plot() function and the plot.xbal() function take in this ggplot argument and both produce the same plot. 

Furthermore, this balance test was created using the xBalance() function as opposed to the balanceTest() function. This allows the inclusion of stratification via the fullmatch() function from the optmatch library into the plots. 


```{r}
build_vignettes(pkg = "C:/Users/17349/Documents/Undergraduate Research/RItools")



```
# include more features of ggplpot such as themes (update vignette)
# include plot with more variables. go through data documentation
# write up brief explanation of data
# include categorical variables and grouped variables
# run build_vignettes() in console, ignore incomplete line error at end
# move top part into new file, delete the vignette


